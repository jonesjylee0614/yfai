# 技术栈与实现规划

> 本文基于 `docs/设计文档.md` 所述“本地对话式控制台”目标，梳理可落地的技术栈与核心实现路径，用于指导 MVP 与 V1.0 的实现。

## 1. 背景与目标
- 梳理并固化 UI、Orchestrator、Provider、LocalOps 等模块的技术选型，加快首个可用版本交付。
- 明确用户输入→工具执行→审计记录的流程，确保安全与可审计能力从首版即内建。
- 为后续插件化、微服务化与跨平台扩展预留接口和边界。

## 2. 技术栈总览
| 层级 | 主要技术 | 说明 |
| --- | --- | --- |
| 运行时与工程 | Python 3.11+、`poetry` 或 `uv`、`ruff`、`mypy`、`pre-commit` | 快速迭代与静态规范；可结合 `pyinstaller`/`briefcase` 生成可执行包 |
| 桌面与交互 | `PyQt6`、`Qt Designer`、`qasync`、`qframelesswindow` | 构建 Win11 友好的单窗口体验，兼容异步消息循环 |
| 编排与核心逻辑 | `asyncio`、`pydantic`、`httpx`、`tenacity` | 统一封装 Provider/MCP 调用、重试与超时策略 |
| 模型与工具接入 | `dashscope` SDK、`ollama` HTTP API、`mcp-client-python` | 支持百炼与本地 Ollama；与 MCP Server 通信 |
| 本地控制与安全 | `psutil`、`watchdog`、`pyyaml`、`cryptography`、`typer` | 封装文件/进程/脚本操作，依据策略与审批执行 |
| 数据与存储 | `SQLite`、`sqlite-vec` 或 `faiss`、`SQLAlchemy`、`structlog` | 存储对话、工具调用、向量索引与审计日志 |
| 测试与交付 | `pytest`、`pytest-qt`、`Playwright`（可选）、`github actions` | 自动化测试 UI/流程，持续集成与版本发布 |

## 3. 核心业务流程
1. **启动自检**：读取 `config.yaml` 与 `McpRegistry.yaml`，校验 API Key、MCP 可达性、向量库初始化。
2. **会话编排**：UI 收集用户输入，`core/orchestrator` 构建上下文，匹配显式指令或生成执行计划。
3. **Provider 路由**：`ProviderManager` 基于任务类型、模型健康度选用百炼或 Ollama，支持流式输出与降级。
4. **工具调用**：按计划优先匹配规则/快捷命令，其次交给模型 tool choice；危险级操作触发审批弹窗。
5. **执行与采集**：`localops` 或 MCP 工具执行任务，采集 stdout/stderr、结构化结果，写入 SQLite 与向量索引。
6. **审计与回溯**：`security/guard` 记录审批人、执行参数、风险等级，可通过 UI 历史面板导出 Markdown/CSV。

## 4. 模块实现要点
- `app/`：PyQt6 主窗体（对话区、工具侧栏、审批弹窗、记录面板），通过 `qasync` 与核心协程解耦。
- `core/`：Orchestrator、计划管理、失败恢复策略；结合 `pydantic` 建模消息与计划，支持断点续传。
- `providers/`：百炼与 Ollama 适配器，统一 `chat()`/`stream_chat()` 接口，集成限流与熔断。
- `mcp/`：MCP 客户端、注册中心、工具目录缓存，支持规则优先 + LLM 重排的选择策略。
- `localops/`：文件、进程、脚本、网络等微模块，结合权限白名单与危险等级，支持沙箱执行与超时。
- `security/` 与 `store/`：实现审批策略、日志脱敏、向量检索；`store/db.py` 通过 `SQLAlchemy` 管理最小数据模型。

## 5. 研发里程碑
- **MVP（1–2 周）**：完成对话 UI、Provider 抽象、基础 MCP 调用、LocalOps 只读能力、审批弹窗、SQLite 审计与健康检查。
- **V1.0（再 2–4 周）**：加入 RAG 检索、脚本模板库、错误归因、导出功能、LocalOps 作为 MCP Server、模型路由策略中心。
- **后续演进**：DevOps 工具化、网络调试套件、个人术语库、Orchestrator 服务化、跨平台支持。
- **工程支撑**：建立单元/集成/UI 测试矩阵，配置 GitHub Actions CI、版本标签与发布包，配套文档与变更日志。

## 6. 风险与对策
- **安全合规**：默认只读，危险操作强制审批；敏感路径/环境变量脱敏；执行沙箱化与超时控制。
- **性能与稳定性**：使用异步 IO 与连接池；关键调用配置重试/降级；对 Provider/MCP 做健康监控。
- **可扩展性**：通过目录划分与接口抽象，保持模块内聚；CLI/HTTP 适配器与插件机制预留扩展点。

