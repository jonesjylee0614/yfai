# YFAI 功能清单

## 1. 产品定位与总体架构
- 单窗口“本地对话式控制台”统一调度 DashScope、Ollama、MCP 工具与本地控制模块，目标是“一个窗口，统一调用 AI & 工具 & 本机能力”（`README.md:1`, `README.md:7`, `docs/设计文档.md:3`）。
- 体系结构：PyQt6 UI → Orchestrator → Providers（DashScope/Ollama）→ MCP Servers/LocalOps → Store，并由 Security & Governance 模块包裹，确保权限、审批与日志（`docs/设计文档.md:7`）。
- 技术栈与工程基线：Python 3.11+、Poetry/uv、PyQt6、asyncio+httpx+tenacity、DashScope SDK、Ollama HTTP API、psutil、SQLite+FAISS、pytest/pytest-qt/Playwright、GitHub Actions 等（`docs/技术栈与实现规划.md:10`）。
- 端到端业务流：启动自检→会话编排→模型路由→工具调用→执行采集→审计回溯，确保每步都可观测（`docs/技术栈与实现规划.md:22`）。

## 2. 桌面客户端与交互
- 主窗口使用三栏 QSplitter（侧栏/对话区/可折叠工具面板），集成菜单栏、工具栏、状态栏、Provider 切换与健康检查按钮（`yfai/app/main_window.py:38`, `yfai/app/main_window.py:91`, `yfai/app/main_window.py:134`, `yfai/app/main_window.py:146`, `yfai/app/main_window.py:217`）。
- ChatWidget 支持消息气泡、Shift+Enter 换行 & Enter 发送、异步新建会话、流式增量渲染与状态提示（`yfai/app/widgets/chat_widget.py:71`, `yfai/app/widgets/chat_widget.py:103`, `yfai/app/widgets/chat_widget.py:138`, `yfai/app/widgets/chat_widget.py:171`）。
- Sidebar 导航提供对话、助手、会话、知识库、工具、日志、设置等入口，并广播页面切换事件（`yfai/app/widgets/sidebar.py:31`, `yfai/app/widgets/sidebar.py:40`, `yfai/app/widgets/sidebar.py:88`）。
- ToolsPanel 维护带风险着色的本地工具清单并提供搜索过滤，方便快速调用（`yfai/app/widgets/tools_panel.py:24`, `yfai/app/widgets/tools_panel.py:47`）。
- SettingsDialog 以分栏形式管理通用、Provider、安全三类偏好，覆盖自动保存、流式输出、超时、API Key、Ollama 地址、审计策略等（`yfai/app/widgets/settings_dialog.py:24`, `yfai/app/widgets/settings_dialog.py:63`, `yfai/app/widgets/settings_dialog.py:87`, `yfai/app/widgets/settings_dialog.py:119`）。
- 原型前端补齐了完整的助手管理、会话历史、知识库、工具侧栏、审批弹窗、命令面板、日志与系统设置等高保真页面，并提供 9 页面/7 模块/30+ 命令的示例数据（`prototype/FEATURES.md:7`, `prototype/FEATURES.md:20`, `prototype/FEATURES.md:51`, `prototype/FEATURES.md:82`, `prototype/FEATURES.md:124`, `prototype/FEATURES.md:152`, `prototype/FEATURES.md:186`, `prototype/FEATURES.md:205`）。

## 3. 对话编排与会话管理
- Orchestrator 负责创建会话、保存用户/助手消息并维持当前 session id（`yfai/core/orchestrator.py:46`, `yfai/core/orchestrator.py:77`）。
- 对话历史通过数据库读取并转为 ChatMessage 列表，供模型调用时复用上下文（`yfai/core/orchestrator.py:210`）。
- 支持流式输出：在 Provider 不可用时即时提示错误，成功返回后再记录完整回复（`yfai/core/orchestrator.py:145`, `yfai/core/orchestrator.py:184`）。
- 健康检查统一查询 Provider 状态、数据库连通性与 MCP 注册统计（`yfai/core/orchestrator.py:415`）。

## 4. 多模型 Provider 能力
- ProviderManager 统一注册百炼与 Ollama，实现健康检查、任务路由、自动降级与模型列表检索（`yfai/providers/manager.py:17`, `yfai/providers/manager.py:57`, `yfai/providers/manager.py:98`, `yfai/providers/manager.py:124`, `yfai/providers/manager.py:160`）。
- BailianProvider 支持重试、工具调用参数、流式输出、usage 统计与模型列表查询（`yfai/providers/bailian.py:35`, `yfai/providers/bailian.py:81`, `yfai/providers/bailian.py:93`, `yfai/providers/bailian.py:154`, `yfai/providers/bailian.py:166`）。
- OllamaProvider 支持本地模型聊天/流式、温度 & num_predict 选项、token 计数、标签查询与模型拉取（`yfai/providers/ollama.py:26`, `yfai/providers/ollama.py:41`, `yfai/providers/ollama.py:81`, `yfai/providers/ollama.py:131`, `yfai/providers/ollama.py:140`, `yfai/providers/ollama.py:152`）。

## 5. MCP 集成与工具生态
- McpRegistry 通过 YAML 维护 server 列表、鉴权方式、可用工具、风险权限映射及启停状态（`yfai/mcp/registry.py:13`, `yfai/mcp/registry.py:51`, `yfai/mcp/registry.py:77`, `yfai/mcp/registry.py:102`, `yfai/mcp/registry.py:122`, `yfai/mcp/registry.py:188`）。
- McpClient 目前以 HTTP 形式提供 connect/tool.list/tool.call/health API，便于后续替换为 WebSocket（`yfai/mcp/client.py:12`, `yfai/mcp/client.py:28`, `yfai/mcp/client.py:50`, `yfai/mcp/client.py:69`, `yfai/mcp/client.py:98`）。
- 配置示例给出多台 MCP Server（files/devops/database）的端点、鉴权、工具白名单及启用状态，便于快速扩展（`configs/config.example.yaml:36`）。

## 6. 本地控制能力（LocalOps）
- 文件系统操作支持白名单校验、读/写/列目录/删除/搜索等并返回风险等级（`yfai/localops/fs.py:12`, `yfai/localops/fs.py:48`, `yfai/localops/fs.py:79`, `yfai/localops/fs.py:118`, `yfai/localops/fs.py:174`, `yfai/localops/fs.py:204`）。
- ShellOps 统一封装 PowerShell/Bash/CMD（含 WSL）异步与同步执行、超时控制与 stdout/stderr 收集（`yfai/localops/shell.py:12`, `yfai/localops/shell.py:29`, `yfai/localops/shell.py:50`, `yfai/localops/shell.py:120`）。
- ProcessOps 提供进程列表、详情、终止、系统信息等指令（`yfai/localops/process.py:11`, `yfai/localops/process.py:65`, `yfai/localops/process.py:101`, `yfai/localops/process.py:140`）。
- NetworkOps 负责 HTTP 请求、端口检测/扫描、IP 查询与 DNS 解析（`yfai/localops/net.py:12`, `yfai/localops/net.py:68`, `yfai/localops/net.py:104`, `yfai/localops/net.py:137`, `yfai/localops/net.py:163`）。
- ToolsPanel 中已预置本地工具到 UI，风险彩色提示配合审批策略（`yfai/app/widgets/tools_panel.py:47`）。

## 7. 安全治理与审批
- SecurityGuard 定义风险枚举、审批请求/结果模型、阈值判定、审批回调、脱敏与审计统计（`yfai/security/guard.py:14`, `yfai/security/guard.py:32`, `yfai/security/guard.py:57`, `yfai/security/guard.py:103`, `yfai/security/guard.py:152`, `yfai/security/guard.py:201`, `yfai/security/guard.py:227`）。
- SecurityPolicy 结合配置里的危险操作与路径白名单，提供判定与风险评级工具（`yfai/security/policy.py:6`, `yfai/security/policy.py:16`, `yfai/security/policy.py:27`, `yfai/security/policy.py:56`）。
- Orchestrator 在执行工具前写入 ToolCall 记录、触发审批、同步状态与 stdout/stderr、写入审批人（`yfai/core/orchestrator.py:231`, `yfai/core/orchestrator.py:249`, `yfai/core/orchestrator.py:271`, `yfai/core/orchestrator.py:306`, `yfai/core/orchestrator.py:326`）。
- 示例配置声明确认阈值、自动审计、敏感路径/环境变量脱敏、危险操作审批清单（`configs/config.example.yaml:64`, `configs/config.example.yaml:80`）。

## 8. 数据存储与知识库
- SQLAlchemy 模型覆盖会话、消息、工具调用、助手、知识库/分块与 KV 存储，并提供 `to_dict`、关系与统计方法（`yfai/store/db.py:28`, `yfai/store/db.py:58`, `yfai/store/db.py:88`, `yfai/store/db.py:129`, `yfai/store/db.py:169`, `yfai/store/db.py:212`）。
- DatabaseManager 负责 SQLite 初始化、Session 工厂、内置助手灌库与全局统计（`yfai/store/db.py:233`, `yfai/store/db.py:259`, `yfai/store/db.py:286`）。
- VectorIndexer 基于 FAISS IndexFlatL2，提供创建、增量写入、检索、保存/加载、删除与统计能力（`yfai/store/indexer.py:14`, `yfai/store/indexer.py:30`, `yfai/store/indexer.py:40`, `yfai/store/indexer.py:61`, `yfai/store/indexer.py:93`, `yfai/store/indexer.py:111`, `yfai/store/indexer.py:139`, `yfai/store/indexer.py:158`）。
- 配置示例为知识库声明 embedding 模型、分块策略、top-k 与相似度阈值（`configs/config.example.yaml:103`）。

## 9. 知识库 RAG 与原型场景
- 原型知识库模块支持多数据源（文档/目录/爬虫/数据库）、多 embedding 选择、分块策略、索引管理、RAG 试运行与统计（`prototype/FEATURES.md:82`）。
- 命令面板、审批弹窗、日志管理、系统设置等原型页面细化了风险提示、快捷命令、审计过滤、MCP 管理等交互，为桌面端实现提供清晰蓝图（`prototype/FEATURES.md:124`, `prototype/FEATURES.md:152`, `prototype/FEATURES.md:186`, `prototype/FEATURES.md:205`, `prototype/FEATURES.md:235`）。
- 视觉与交互规范（深色主题、响应式布局、Toast/Modal/快捷键等）已在原型中给出，可直接迁移到 PyQt6（`prototype/FEATURES.md:268`, `prototype/FEATURES.md:278`, `prototype/FEATURES.md:289`）。

## 10. 配置、运行与交付
- ConfigManager 自动加载 `.env` 与 YAML，支持 get/set/save，并在缺失时回退到示例配置（`yfai/core/config.py:11`, `yfai/core/config.py:20`, `yfai/core/config.py:40`, `yfai/core/config.py:63`, `yfai/core/config.py:80`）。
- 运行指引：Python 3.11+、Poetry/pip 安装、复制 config/.env、`poetry run yfai` 或 `python -m yfai.main`（`README.md:22`, `README.md:29`, `README.md:37`, `README.md:52`）。
- 配置项涵盖模型路由、工具决策模式、流式输出、MCP 注册、LocalOps 白名单与 Shell、RAG 参数、UI 主题等（`configs/config.example.yaml:1`）。
- README 给出 Ruff/MyPy/pytest 的基础工程指令，方便集成 CI（`README.md:170`）。

## 11. 路线图与待办
- MVP/V1.0 里程碑规划了审批弹窗、LocalOps 扩展、RAG、模型路由中心、LocalOps 以 MCP Server 暴露及导出能力（`docs/设计文档.md:176`, `docs/设计文档.md:200`）。
- 技术栈文档和 README TODO 同步列出测试覆盖、文档完善、打包发布等待办项，便于跟踪（`docs/技术栈与实现规划.md:37`, `README.md:193`）。
- 原型统计信息展示 9 页面/7 模块/30+ 命令的完成度，并强调安全/审计创新特性（`prototype/FEATURES.md:336`, `prototype/FEATURES.md:350`, `prototype/FEATURES.md:359`）。

