# YFAI 操作手册

面向桌面端 YFAI 控制台用户，帮助你快速安装、启动并熟练使用各个工作台模块。本手册基于当前代码实现撰写，如无特殊说明默认 Python 3.11 与 Poetry 构建环境。

## 1. 环境准备

1. **安装依赖**
   ```bash
   poetry install
   ```
2. **配置密钥**
   - 复制 `configs/.env.example` 为 `configs/.env`，填入 DashScope、Ollama 等必要的 API Key。
   - 根据 `configs/config.example.yaml` 创建 `configs/config.yaml`，主要调整默认模型、数据库路径或本地操作白名单。

3. **初始化数据库**
   - 首次运行会自动创建 `data/yfai.db` 并注入内置助手/智能体，无需手动建表。

## 2. 启动与登录

```bash
poetry run python -m yfai.main
```

应用使用 PyQt6 + qasync 事件循环，无需额外浏览器。成功启动后会看到三栏布局：左侧导航、中间工作区、右侧可折叠“工具箱”。

## 3. 主界面速览

- **侧边栏**：包含对话、助手、智能体、自动化、连接器、知识库、会话、日志与设置入口，底部展示版本。
- **工具栏**：提供“新建对话”、Provider 选择与健康检查按钮。
- **状态栏**：展示当前操作进度，如正在发送、健康检查结果等。
- **工具面板**：列出本地工具（文件、Shell、网络等）并按风险色标，可通过搜索快速定位。

## 4. 功能模块操作

### 4.1 对话 (Chat)
1. 侧边栏选择 “💬 对话”。
2. 输入框支持 `Shift+Enter` 换行，`Enter` 发送。
3. 顶部下拉切换 Provider（DashScope/Ollama/自动）。
4. 会话记录会实时写入 SQLite，可在“会话”页面查看。

### 4.2 助手管理
1. 打开 “🤖 助手” 页面。
2. 点击 “➕ 创建助手”，填写名称、描述、系统提示词、默认 Provider/模型，支持设置为内置以避免删除。
3. 列表会显示 Provider/模型组合及创建时间，支持编辑/删除（内置不可删）。

### 4.3 智能体管理
1. 进入 “🤵 智能体”，可创建具备系统提示词、工具权限、最大步骤等配置的 Agent。
2. 选中智能体后，在底部输入目标文本并运行；执行情况会记录到“运行记录”页面。

### 4.4 会话管理
1. 打开 “📚 会话”，可查看最近 100 个会话的助手/知识库、消息数与最后活跃时间。
2. `👁` 按钮可弹出会话详情，按时间顺序浏览所有消息。
3. `🗑 清理旧会话` 会删除 30 天未活跃的会话（含消息级联），保持数据库整洁。

### 4.5 知识库
1. 进入 “📖 知识库”，可维护向量化资源。
2. 创建时需选择数据源类型（单文档、目录、Web、数据库），填写路径/地址，并配置嵌入模型与分块策略。
3. 列表展示数据源类型、文档分块数、嵌入模型和最近索引时间，可编辑或删除。

### 4.6 自动化任务
1. 在 “🤖 自动化” 中，可为特定智能体配置定时/事件触发器（interval/cron/file/process/webhook）。
2. 每个任务记录最近运行状态，支持启用/停用、手动触发与删除。

### 4.7 连接器
1. 在 “🔗 连接器” 管理 HTTP、Email、Git、自定义适配器。
2. 创建/编辑对话框会根据类型展示对应字段（URL、认证、SMTP、仓库等）。
3. 列表可执行测试、编辑与删除，状态与最近测试时间清晰可见。

### 4.8 日志与工具
1. “📋 日志” 页面用于查看工具调用、审批记录等（当前仍展示示例数据，可扩展为读取 `tool_calls` 表）。
2. “🔧 工具” 页面仍为占位页，建议使用右侧“工具面板”直接执行常用本地操作。

### 4.9 安全审批
当执行高风险工具（如 `fs.delete`、`shell.exec`）时会弹出审批对话框。可选择拒绝、仅此一次或永久允许，审批结果会写入审计日志（控制台输出）。

## 5. 数据与维护

- **数据库位置**：默认 `data/yfai.db`，可在 `configs/config.yaml` 的 `database.path` 修改。
- **备份**：定期备份 `data/` 目录；如需重置，可删除该文件后重新启动。
- **本地操作白名单**：通过 `config.local_ops.roots_whitelist` 设置，避免误操作系统敏感目录。
- **日志文件**：控制台输出位于 `logs/`，界面日志后续将读取数据库 `tool_calls`、`job_runs`、`automation_tasks` 等表。

## 6. 常用命令

| 场景 | 命令 |
| --- | --- |
| 安装/更新依赖 | `poetry install` |
| 运行桌面端 | `poetry run python -m yfai.main` |
| 快速脚本运行 | `poetry run python run.py` |
| 单元测试 | `poetry run pytest tests/` |
| 集成测试 | `poetry run pytest test_integration.py -k critical` |
| 静态检查 | `poetry run ruff check .` / `poetry run mypy yfai/` |

> 提示：首次运行前请确保 Ollama/DashScope 可连通，必要时在设置菜单里更新 API 地址或密钥。

---

如需进一步扩展（例如接入新的 MCP Server、补齐日志/工具管理等），请参考 `docs/功能清单.md` 与 `docs/设计文档.md` 获取架构细节。欢迎补充新的操作范式并更新本手册。
