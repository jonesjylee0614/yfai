# YFAI 改造实施计划

## 目标概述
- 依托《改造建设方案》将 YFAI 从“单轮对话控制台”升级为“可编排、可调度、可观测的本地智能体工作台”。
- 以“先原型确认、再分阶段实装”的节奏推进，确保长功能链条可逐步交付。

## Phase 0：原型对齐（当前）
- **交付物**：更新 `prototype/` 系列原型与文档，补齐智能体中心、自动化中心、运行观测、连接器、审批弹窗等核心入口。
- **重点**：
  - 在原型中明确侧栏新增入口、各页面布局、交互流程（Agent 详情、Automation 向导、Job 详情、Connector 配置）。
  - 同步 `prototype/FEATURES.md`、`prototype/ROADMAP.md` 的描述与流程图。
- **验收**：产品层确认原型后再开始代码落地。

## Phase 1：Agent & JobRun 落地
- **数据层**：`yfai/store/db.py` 新增 `Agent`、`JobRun`、`JobStep` 表，提供迁移脚本。
- **核心逻辑**：`yfai/core/orchestrator.py` 引入 `AgentRunner`，实现：
  1. 依据系统提示词生成计划（Plan）。
  2. 顺序/循环执行步骤并记录 JobStep。
  3. 与 `security/guard.py` 集成 agent 级工具白名单。
- **UI**：侧栏新增“智能体”入口，提供 Agent 列表/详情；ChatWidget 支持 `/run-as-agent`。
- **测试**：AgentRunner 单测 + JobRun 写入的集成测试。

## Phase 2：Automation & 场景模板
- **调度框架**：新增 `yfai/automation/scheduler.py`，支持 cron / interval / once；`AutomationTask` 表记录任务元数据。
- **触发器**：先实现文件监听、进程状态、手动触发，统一调用 AgentRunner 或 Workflow 模板。
- **UI**：Automation 页面（列表、创建、启用、立即执行）；Personal Workspace 提供“项目助手”“系统巡检”“知识整理”模板。
- **配置/文档**：`configs/config.example.yaml` 增加 automation 示例；`docs/` 撰写使用指南。
- **测试**：Scheduler 触发 + 典型场景端到端用例。

## Phase 3：Connector Framework
- **实现**：`yfai/connectors/{base,email,git,http}.py` + `Connector` 表，LocalOps 新增 `connector.py` 对接统一入口。
- **UI**：连接器管理页，包含创建、编辑、测试连接、状态展示。
- **安全**：Connector 调用走同一审批体系，JobStep 记录调用快照。
- **扩展**：保留将 Connector 通过 MCP 暴露的接口，后续可复用。

## Phase 4：运行观测 & 权限体验完善
- **运行中心**：新增 Job 列表/详情界面，支持重跑、从指定 Step 继续；展示每步输入输出。
- **审批体验**：审批弹窗支持“仅此一次 / 对该 Agent 永久允许”；在 JobStep 中显示审批记录与审批人。
- **安全策略**：`security/policy.py` 增 agent/task 级风险阈值、默认危险工具列表。

## Phase 5：质量与发布
- **测试矩阵**：补齐 pytest、集成测试、Ruff/Mypy gate；关键模块（Agent/Automation/Connector/Security）需覆盖典型路径。
- **文档更新**：刷新 `README.md`、`CHANGELOG.md`、`PROJECT_SUMMARY.md`，说明新能力与配置步骤。
- **发布清单**：整理 release note、示例配置、常见问题，确保可复制部署。

## 里程碑依赖
1. Phase 0 完成 → 才能启动 Phase 1 开发。
2. Phase 1（Agent+Job）完成 → 才能接入 Automation（Phase 2）与 Connector（Phase 3）。
3. Phase 2 输出的场景模板将依赖 Phase 3 的对外能力，可并行 but 需要接口契约。
4. Phase 4 依赖前述 Job 数据与权限模型；Phase 5 做整体质量收口。

## 验收与追踪
- 每 Phase 输出：原型/代码/测试/文档四项检查清单。
- 通过 `docs/改造计划.md` 持续追踪进度，必要时在 `PROJECT_SUMMARY.md` 追加最新状态。
