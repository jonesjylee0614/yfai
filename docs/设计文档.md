# 核心定位

本地“对话式控制台”：统一接入百炼（DashScope）与本地 Ollama，作为 **MCP Client** 调用各类 MCP Server（本地/远程工具），并暴露一套“可审计的本地控制能力”（文件、进程、网络、脚本、窗口自动化等）。目标是：**一个窗口，统一调用 AI & 工具 & 本机能力**。

---

# 整体架构（单机优先，易扩展）

```mermaid
flowchart LR
UI[对话窗口/命令面板] -- JSON RPC --> Core[Orchestrator 核心调度]
Core -- Provider SDK --> LLMs[(LLM Providers)]
LLMs -->|DashScope| Bailian[阿里百炼]
LLMs -->|HTTP| Ollama[Ollama 本地]

Core -- MCP Client --> MCP[MCP Servers Registry]
MCP --> Tools[外部工具能力(API/DB/搜索/DevOps等)]

Core -- Local Capabilities --> LocalOps[本地控制模块]
LocalOps --> FS[文件系统/剪贴板/窗口/键鼠]
LocalOps --> Shell[Shell/PowerShell/Python/Go 脚本]
LocalOps --> Net[HTTP/WebSocket/端口监听]
Core --> Store[(本地嵌入式存储：SQLite + 向量库)]
Store --> Logs[对话/调用日志]
Store --> Vault[密钥保险箱]

subgraph Security&Governance
Guard[权限/审批/白名单/审计]
Mask[Prompt模板/脱敏/红线策略]
Rate[限流/熔断/重试]
end
```

**技术选型（建议）**

* 桌面端：**PyQt6**（你之前倾向，Win11 友好；也便于调用本地脚本/工具）
* 核心：Python 3.11+（快速整合百炼/Ollama/MCP；后期可拆 Go 微服务）
* 本地向量库：SQLite + `sqlite-vec` / `faiss`（小而稳；后续可换 Milvus/Weaviate）
* 配置：YAML + `.env`（多环境切换）
* 扩展：MCP Client（如 mcp-client-python）+ 自研本地 Tool SDK（与 MCP 对齐）

---

# 核心模块设计

## 1) Provider 抽象（LLM 统一接口）

* `ProviderManager`：注册/选择/健康检查/熔断
* 统一方法：`chat(messages, tools, model, stream, timeout)`
* 适配：

  * **BailianAdapter**：DashScope 的聊天/工具调用接口、流式输出
  * **OllamaAdapter**：`/api/chat` 或 `/api/generate`、本地模型管理（pull/list）

## 2) MCP 客户端与注册中心

* `McpRegistry.yaml`：声明可用 MCP Servers（地址、认证、可用工具、超时、限额）
* `McpClient`：握手、`tool.list`、`tool.call`，维护会话上下文
* Tool 选择策略：**规则优先 + LLM 备选重排**（本地可选开关）

## 3) 本地控制能力（LocalOps）

* **动作集合**（全部可开关/需审批）：

  * 文件：读/写/删/重命名/搜索/批量重命名
  * 进程：启动/结束/查询
  * 脚本：PowerShell / Bash(WSL) / Python / Go（带模板与输出采集）
  * UI 自动化：pywinauto/pynput（可选）、截图/OCR（可选）
  * 网络：HTTP 调用、端口探测、curl 任务
  * 剪贴板/系统通知
* **权限模型**：

  * 动作分级：危险（删/改）、中危（执行）、低危（读）
  * 资源范围：目录白名单、端口白名单、命令白名单
  * 审批流：**JIT 弹窗**（展示执行计划 → 用户确认 → 执行）
  * 审计：请求参数、输出、退出码、调用来源（LLM/MCP/用户）

## 4) Orchestrator（对话编排）

* 工具路由：先匹配“显式指令/快捷命令/规则”，否则交给 LLM 的 tool choice
* 计划执行：将复杂需求拆分为步骤（计划 → 审批 → 执行 → 汇报）
* 失败恢复：重试策略、降级到本地/替代 Provider、回滚（如文件变更前后对比）
* 记忆 & RAG：对本地文档/日志建立索引，允许“引用检索”辅助回答

## 5) 日志与审计

* SQLite：对话表、工具表、执行记录表、审批记录表
* 可导出：CSV/Markdown；支持筛选（时间/工具/危险级别/关键词）

## 6) 配置与密钥

* `config.yaml` 核心项：模型路由策略、默认 provider、超时、向量维度、MCP 列表、本地动作白名单
* `vault/`：`.env` + Windows 凭据管理器（可选）存储 `DASHSCOPE_API_KEY` 等

---

# 交互与 UX（务实高效）

## 窗口

* **主对话区**：流式输出 + 思路摘要（可选）
* **工具侧栏**：MCP/本地工具目录（可搜索/一键运行/参数表单）
* **审批弹窗**：展示“谁要做什么”，参数 diff，估计影响，确认/拒绝/降权执行
* **命令面板**（Ctrl+K）：`> 新建PowerShell脚本`、`> 索引此目录为知识库`、`> 启停 MCP server`
* **记录区**：近期动作、错误、回滚入口
* **模型与路由切换**：顶部下拉（Bailian / Ollama / Auto）

## 输入语法（以自然语言为主，支持“命令模式”）

* 自然语言：“把 D:\logs*.log 合并去重并统计前 10 IP”
* 命令模式：`/ps "Get-Process | sort CPU -desc | select -f 10"`、`/tool whois domain=a.com`

---

# 配置样例（可直接落地）

**config.yaml**

```yaml
app:
  default_provider: bailian
  model_route:
    coding: ollama:qwen2.5-coder
    general: bailian:qwen-plus
    offline_only: ollama:llama3.1
  tool_decision: rule_first_then_llm
  timeout_sec: 60

providers:
  bailian:
    api_base: https://dashscope.aliyuncs.com/compatible-mode/v1
    api_key_env: DASHSCOPE_API_KEY
  ollama:
    api_base: http://127.0.0.1:11434

mcp:
  registry:
    - name: files
      endpoint: ws://127.0.0.1:9001
      auth: none
      allow_tools: ["fs.read","fs.write","fs.search"]
    - name: devops
      endpoint: wss://mcp.example.com
      auth: bearer:${MCP_TOKEN}
      allow_tools: ["k8s.describe","jenkins.trigger","git.ops"]

local_ops:
  roots_whitelist:
    - "D:/WorkSpace"
    - "C:/Users/Administrator/Desktop"
  dangerous_ops:
    require_approval: ["delete","process.kill","script.exec","net.port_open"]
  shell:
    default: powershell
    wsl: true

security:
  confirm_threshold: medium
  redact:
    paths: ["C:/Users/Administrator/.ssh", "C:/Secrets"]
    envs: ["AWS_*","OPENAI_*","DASHSCOPE_*"]
```

---

# 数据模型（SQLite 表最小集）

* `sessions(id, created_at, title, tags)`
* `messages(id, session_id, role, content, provider, created_at)`
* `tool_calls(id, session_id, tool_name, params_json, approved_by, risk_level, status, stdout, stderr, started_at, ended_at)`
* `kvstore(ns, key, value_json, updated_at)`（配置/缓存）
* `chunks(hash, path, meta_json, content_vector)`（RAG 索引）

---

# MVP（1–2 周可做完）

**目标**：能“对话 + 调用 MCP + 控制本地（最小危险集）+ 审批 + 记录”。

* [ ] PyQt6 单窗体：对话区 + 侧栏（工具列表）+ 审批弹窗
* [ ] Provider 抽象 + Bailian & Ollama 适配（流式输出）
* [ ] MCP Client：注册中心 → 列表 → 调用（同步/超时/错误提示）
* [ ] LocalOps（MVP 权限集）：

  * 文件读取（只读）、目录搜索（白名单内）
  * 运行 **只读** 命令：`dir`, `type`, `Get-ChildItem`（PowerShell）
* [ ] 审批流：危险操作一律弹窗，日志落库
* [ ] `config.yaml` + `.env`，开机自检（连通性/健康检查）
* [ ] 日志面板：最近 50 条（可导出 .md）

**交互示例**

1. 你输入：`把 D:\logs\*.log 合并去重并统计前 10 IP`
2. Orchestrator 生成计划 → 提议使用本地 `PowerShell` 脚本
3. 弹窗：展示要执行的脚本与输出保存路径 → 你确认
4. 执行、采集 stdout → 渲染表格 → 可“保存为 CSV”

---

# V1.0（再加 2–4 周）

* RAG：对目录建索引（异步），`#search <query>` 自动引用片段回答
* 本地脚本模板库：PS/Bash/Python 可参数化运行
* UI 自动化（可选）：窗口查找/截图/OCR
* 多会话/标签/固定系统指令（Prompt Preset）
* 模型路由策略中心（按任务类型动态选 Provider）
* 错误归因与重试（网络/工具/权限的区分）
* 导出：对话+审计打包（zip）
* 插件：**将 LocalOps 以 MCP Server 形式暴露**（自洽、可远程复用）

---

# 安全与治理（关键点）

* **默认拒绝一切“改写/删除/执行”**，只读需明示开通
* 标注 **调用来源**（用户直呼 / LLM 决策 / MCP 转发）
* **沙箱**：脚本执行可选在临时工作目录 + 超时 + 只读挂载
* 敏感路径与环境变量自动脱敏
* 具名危险等级（LOW/MEDIUM/HIGH/CRITICAL） + 审批记录

---

# 路线图（面向你的场景）

* **DevOps 套件**：MCP 接 Git/Jenkins/K8s；一键“跑供应商隔离验证流水线”
* **网络调试工具化**：封装你常用的 `route/netsh/tcpdump/wireshark-cli` 为安全工具
* **个人翻译/术语库**：本地词库 + RAG，结合窗口取词
* **可移植微服务**：将 Orchestrator 独立成本地 HTTP 服务，GUI/CLI/REST 共用

---

# 目录结构（建议）

```
ai-console/
  app/                # PyQt6 UI
  core/               # Orchestrator / Router / Plans
  providers/          # bailian.py, ollama.py
  mcp/                # client.py, registry.py
  localops/           # fs.py, shell.py, process.py, net.py
  security/           # guard.py, policy.py
  store/              # db.py, indexer.py
  configs/            # config.yaml, env.sample
  scripts/            # ps/bash/python templates
  tests/
  main.py
```

