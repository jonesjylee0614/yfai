<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘½ä»¤é¢æ¿</title>
    <link rel="stylesheet" href="assets/common.css">
    <style>
        body {
            padding: 0;
            overflow: hidden;
        }

        .palette-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .palette-container {
            width: 90%;
            max-width: 700px;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .palette-search {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            font-size: 20px;
            color: var(--text-secondary);
        }

        .palette-input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            background: var(--bg-light);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .palette-input:focus {
            border-color: var(--primary-color);
            background: var(--bg-darker);
        }

        .palette-tabs {
            display: flex;
            padding: 12px 20px;
            gap: 8px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-color);
        }

        .palette-tab {
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .palette-tab:hover {
            color: var(--text-primary);
            background: var(--bg-light);
        }

        .palette-tab.active {
            color: var(--primary-color);
            background: rgba(24, 144, 255, 0.1);
            border-color: var(--primary-color);
        }

        .palette-results {
            max-height: 400px;
            overflow-y: auto;
            padding: 8px;
        }

        .command-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            border: 1px solid transparent;
        }

        .command-item:hover,
        .command-item.selected {
            background: var(--bg-light);
            border-color: var(--primary-color);
        }

        .command-icon {
            font-size: 24px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .command-content {
            flex: 1;
            min-width: 0;
        }

        .command-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .command-desc {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .command-shortcut {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-darker);
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .command-category {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(24, 144, 255, 0.2);
            color: var(--primary-color);
        }

        .palette-footer {
            padding: 12px 20px;
            background: var(--bg-darker);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .footer-hints {
            display: flex;
            gap: 16px;
        }

        .footer-hint {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .hint-key {
            background: var(--bg-light);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid var(--border-color);
            font-family: monospace;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .recent-commands {
            padding: 8px;
        }

        .recent-title {
            font-size: 12px;
            color: var(--text-secondary);
            padding: 8px 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="palette-overlay" onclick="handleOverlayClick(event)">
        <div class="palette-container" onclick="event.stopPropagation()">
            <!-- æœç´¢æ¡† -->
            <div class="palette-search">
                <div class="search-input-wrapper">
                    <span class="search-icon">ğŸ”</span>
                    <input 
                        type="text" 
                        class="palette-input" 
                        id="commandInput"
                        placeholder="è¾“å…¥å‘½ä»¤æˆ–æœç´¢... (æ”¯æŒ / å‰ç¼€å‘½ä»¤)"
                        autofocus
                        oninput="handleSearch(this.value)"
                        onkeydown="handleKeydown(event)"
                    >
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µ -->
            <div class="palette-tabs">
                <div class="palette-tab active" onclick="switchCategory('all')">
                    å…¨éƒ¨
                </div>
                <div class="palette-tab" onclick="switchCategory('file')">
                    ğŸ“ æ–‡ä»¶
                </div>
                <div class="palette-tab" onclick="switchCategory('shell')">
                    âš¡ è„šæœ¬
                </div>
                <div class="palette-tab" onclick="switchCategory('mcp')">
                    ğŸ”§ MCP
                </div>
                <div class="palette-tab" onclick="switchCategory('system')">
                    âš™ï¸ ç³»ç»Ÿ
                </div>
            </div>

            <!-- å‘½ä»¤åˆ—è¡¨ -->
            <div class="palette-results" id="commandResults">
                <div class="recent-commands" id="recentCommands">
                    <div class="recent-title">æœ€è¿‘ä½¿ç”¨</div>
                    <!-- æœ€è¿‘å‘½ä»¤ä¼šåŠ¨æ€æ’å…¥ -->
                </div>
                <div id="allCommands">
                    <!-- æ‰€æœ‰å‘½ä»¤ä¼šåŠ¨æ€æ’å…¥ -->
                </div>
            </div>

            <!-- åº•éƒ¨æç¤º -->
            <div class="palette-footer">
                <div class="footer-hints">
                    <div class="footer-hint">
                        <span class="hint-key">â†‘â†“</span>
                        <span>å¯¼èˆª</span>
                    </div>
                    <div class="footer-hint">
                        <span class="hint-key">Enter</span>
                        <span>æ‰§è¡Œ</span>
                    </div>
                    <div class="footer-hint">
                        <span class="hint-key">Esc</span>
                        <span>å…³é—­</span>
                    </div>
                </div>
                <div id="resultCount">0 æ¡ç»“æœ</div>
            </div>
        </div>
    </div>

    <script src="assets/common.js"></script>
    <script>
        // å‘½ä»¤æ•°æ®
        const commands = [
            // æ–‡ä»¶æ“ä½œ
            { id: 'file-read', icon: 'ğŸ“–', title: 'è¯»å–æ–‡ä»¶', desc: 'è¯»å–æŒ‡å®šæ–‡ä»¶å†…å®¹', category: 'file', command: '/file read' },
            { id: 'file-search', icon: 'ğŸ”', title: 'æœç´¢æ–‡ä»¶', desc: 'åœ¨ç›®å½•ä¸­æœç´¢æ–‡ä»¶', category: 'file', command: '/file search' },
            { id: 'file-list', icon: 'ğŸ“‹', title: 'åˆ—å‡ºæ–‡ä»¶', desc: 'åˆ—å‡ºç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶', category: 'file', command: '/file list' },
            { id: 'file-index', icon: 'ğŸ—‚ï¸', title: 'ç´¢å¼•ç›®å½•', desc: 'ä¸ºç›®å½•å»ºç«‹çŸ¥è¯†åº“ç´¢å¼•', category: 'file', command: '/index' },
            
            // Shell è„šæœ¬
            { id: 'shell-ps', icon: 'âš¡', title: 'PowerShell', desc: 'æ‰§è¡Œ PowerShell å‘½ä»¤', category: 'shell', command: '/ps', shortcut: 'Ctrl+Shift+P' },
            { id: 'shell-bash', icon: 'ğŸ§', title: 'Bash (WSL)', desc: 'æ‰§è¡Œ Bash å‘½ä»¤', category: 'shell', command: '/bash' },
            { id: 'shell-python', icon: 'ğŸ', title: 'Python è„šæœ¬', desc: 'è¿è¡Œ Python è„šæœ¬', category: 'shell', command: '/python' },
            { id: 'shell-template', icon: 'ğŸ“', title: 'è„šæœ¬æ¨¡æ¿', desc: 'ä½¿ç”¨é¢„å®šä¹‰è„šæœ¬æ¨¡æ¿', category: 'shell', command: '/template' },
            
            // MCP å·¥å…·
            { id: 'mcp-list', icon: 'ğŸ“¡', title: 'åˆ—å‡º MCP å·¥å…·', desc: 'æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„ MCP å·¥å…·', category: 'mcp', command: '/mcp list' },
            { id: 'mcp-call', icon: 'ğŸ”§', title: 'è°ƒç”¨ MCP å·¥å…·', desc: 'ç›´æ¥è°ƒç”¨ MCP å·¥å…·', category: 'mcp', command: '/tool' },
            { id: 'mcp-start', icon: 'â–¶ï¸', title: 'å¯åŠ¨ MCP æœåŠ¡', desc: 'å¯åŠ¨æŒ‡å®šçš„ MCP æœåŠ¡å™¨', category: 'mcp', command: '/mcp start' },
            { id: 'mcp-stop', icon: 'â¹ï¸', title: 'åœæ­¢ MCP æœåŠ¡', desc: 'åœæ­¢æŒ‡å®šçš„ MCP æœåŠ¡å™¨', category: 'mcp', command: '/mcp stop' },
            
            // ç³»ç»Ÿæ“ä½œ
            { id: 'sys-new-chat', icon: 'ğŸ’¬', title: 'æ–°å»ºå¯¹è¯', desc: 'å¼€å§‹æ–°çš„å¯¹è¯ä¼šè¯', category: 'system', command: '/new', shortcut: 'Ctrl+N' },
            { id: 'sys-settings', icon: 'âš™ï¸', title: 'æ‰“å¼€è®¾ç½®', desc: 'æ‰“å¼€ç³»ç»Ÿè®¾ç½®é¡µé¢', category: 'system', command: '/settings' },
            { id: 'sys-logs', icon: 'ğŸ“‹', title: 'æŸ¥çœ‹æ—¥å¿—', desc: 'æŸ¥çœ‹ç³»ç»Ÿæ“ä½œæ—¥å¿—', category: 'system', command: '/logs' },
            { id: 'sys-export', icon: 'ğŸ’¾', title: 'å¯¼å‡ºå¯¹è¯', desc: 'å¯¼å‡ºå½“å‰å¯¹è¯è®°å½•', category: 'system', command: '/export' },
            { id: 'sys-clear', icon: 'ğŸ—‘ï¸', title: 'æ¸…ç©ºå¯¹è¯', desc: 'æ¸…ç©ºå½“å‰å¯¹è¯å†…å®¹', category: 'system', command: '/clear' },
            { id: 'sys-help', icon: 'â“', title: 'å¸®åŠ©æ–‡æ¡£', desc: 'æŸ¥çœ‹ä½¿ç”¨å¸®åŠ©å’Œæ–‡æ¡£', category: 'system', command: '/help', shortcut: 'F1' },
            
            // è¿›ç¨‹ç®¡ç†
            { id: 'proc-list', icon: 'ğŸ“Š', title: 'è¿›ç¨‹åˆ—è¡¨', desc: 'æŸ¥çœ‹ç³»ç»Ÿè¿›ç¨‹åˆ—è¡¨', category: 'system', command: '/ps list' },
            { id: 'proc-kill', icon: 'ğŸ”´', title: 'ç»“æŸè¿›ç¨‹', desc: 'ç»“æŸæŒ‡å®šè¿›ç¨‹', category: 'system', command: '/ps kill' },
            
            // ç½‘ç»œå·¥å…·
            { id: 'net-http', icon: 'ğŸŒ', title: 'HTTP è¯·æ±‚', desc: 'å‘é€ HTTP/HTTPS è¯·æ±‚', category: 'system', command: '/http' },
            { id: 'net-ping', icon: 'ğŸ“¡', title: 'Ping æµ‹è¯•', desc: 'æµ‹è¯•ç½‘ç»œè¿é€šæ€§', category: 'system', command: '/ping' },
            
            // æ¨¡å‹åˆ‡æ¢
            { id: 'model-bailian', icon: 'ğŸ¤–', title: 'åˆ‡æ¢åˆ°ç™¾ç‚¼', desc: 'ä½¿ç”¨é˜¿é‡Œç™¾ç‚¼æ¨¡å‹', category: 'system', command: '/model bailian' },
            { id: 'model-ollama', icon: 'ğŸ¦™', title: 'åˆ‡æ¢åˆ° Ollama', desc: 'ä½¿ç”¨æœ¬åœ° Ollama æ¨¡å‹', category: 'system', command: '/model ollama' }
        ];

        let currentCategory = 'all';
        let filteredCommands = [...commands];
        let selectedIndex = 0;
        let recentCommands = Storage.get('recentCommands', []);

        // åˆå§‹åŒ–
        window.onload = function() {
            renderCommands();
            renderRecentCommands();
        };

        // æ¸²æŸ“å‘½ä»¤åˆ—è¡¨
        function renderCommands() {
            const container = document.getElementById('allCommands');
            container.innerHTML = '';
            
            if (filteredCommands.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ”</div>
                        <div>æœªæ‰¾åˆ°åŒ¹é…çš„å‘½ä»¤</div>
                    </div>
                `;
                document.getElementById('resultCount').textContent = '0 æ¡ç»“æœ';
                return;
            }

            filteredCommands.forEach((cmd, index) => {
                const item = document.createElement('div');
                item.className = `command-item ${index === selectedIndex ? 'selected' : ''}`;
                item.onclick = () => executeCommand(cmd);
                
                item.innerHTML = `
                    <div class="command-icon">${cmd.icon}</div>
                    <div class="command-content">
                        <div class="command-title">
                            ${cmd.title}
                            <span class="command-category">${getCategoryName(cmd.category)}</span>
                        </div>
                        <div class="command-desc">${cmd.desc} Â· ${cmd.command}</div>
                    </div>
                    ${cmd.shortcut ? `<div class="command-shortcut">${cmd.shortcut}</div>` : ''}
                `;
                
                container.appendChild(item);
            });

            document.getElementById('resultCount').textContent = `${filteredCommands.length} æ¡ç»“æœ`;
        }

        // æ¸²æŸ“æœ€è¿‘å‘½ä»¤
        function renderRecentCommands() {
            const container = document.getElementById('recentCommands');
            
            if (recentCommands.length === 0) {
                container.style.display = 'none';
                return;
            }

            const recentItems = recentCommands
                .map(id => commands.find(c => c.id === id))
                .filter(c => c)
                .slice(0, 5);

            let html = '<div class="recent-title">æœ€è¿‘ä½¿ç”¨</div>';
            
            recentItems.forEach(cmd => {
                html += `
                    <div class="command-item" onclick="executeCommand(${JSON.stringify(cmd).replace(/"/g, '&quot;')})">
                        <div class="command-icon">${cmd.icon}</div>
                        <div class="command-content">
                            <div class="command-title">${cmd.title}</div>
                            <div class="command-desc">${cmd.command}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // æœç´¢å‘½ä»¤
        function handleSearch(query) {
            query = query.toLowerCase().trim();
            
            if (!query) {
                filteredCommands = currentCategory === 'all' 
                    ? [...commands] 
                    : commands.filter(c => c.category === currentCategory);
            } else {
                filteredCommands = commands.filter(cmd => {
                    const matchCategory = currentCategory === 'all' || cmd.category === currentCategory;
                    const matchQuery = 
                        cmd.title.toLowerCase().includes(query) ||
                        cmd.desc.toLowerCase().includes(query) ||
                        cmd.command.toLowerCase().includes(query);
                    return matchCategory && matchQuery;
                });
            }
            
            selectedIndex = 0;
            renderCommands();
        }

        // åˆ‡æ¢åˆ†ç±»
        function switchCategory(category) {
            currentCategory = category;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.palette-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // é‡æ–°æœç´¢
            const query = document.getElementById('commandInput').value;
            handleSearch(query);
        }

        // é”®ç›˜å¯¼èˆª
        function handleKeydown(event) {
            switch(event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, filteredCommands.length - 1);
                    renderCommands();
                    scrollToSelected();
                    break;
                    
                case 'ArrowUp':
                    event.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    renderCommands();
                    scrollToSelected();
                    break;
                    
                case 'Enter':
                    event.preventDefault();
                    if (filteredCommands[selectedIndex]) {
                        executeCommand(filteredCommands[selectedIndex]);
                    }
                    break;
                    
                case 'Escape':
                    window.close();
                    break;
            }
        }

        // æ»šåŠ¨åˆ°é€‰ä¸­é¡¹
        function scrollToSelected() {
            const selected = document.querySelector('.command-item.selected');
            if (selected) {
                selected.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        }

        // æ‰§è¡Œå‘½ä»¤
        function executeCommand(cmd) {
            // ä¿å­˜åˆ°æœ€è¿‘ä½¿ç”¨
            recentCommands = [cmd.id, ...recentCommands.filter(id => id !== cmd.id)].slice(0, 10);
            Storage.set('recentCommands', recentCommands);
            
            // å‘é€å‘½ä»¤åˆ°ä¸»çª—å£
            if (window.opener) {
                window.opener.postMessage({
                    type: 'executeCommand',
                    command: cmd
                }, '*');
            }
            
            Utils.showToast(`æ‰§è¡Œå‘½ä»¤: ${cmd.title}`, 'success');
            
            // å…³é—­çª—å£
            setTimeout(() => window.close(), 300);
        }

        // è·å–åˆ†ç±»åç§°
        function getCategoryName(category) {
            const names = {
                file: 'æ–‡ä»¶',
                shell: 'è„šæœ¬',
                mcp: 'MCP',
                system: 'ç³»ç»Ÿ'
            };
            return names[category] || category;
        }

        // ç‚¹å‡»é®ç½©å…³é—­
        function handleOverlayClick(event) {
            if (event.target.classList.contains('palette-overlay')) {
                window.close();
            }
        }

        // ESC å…³é—­
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                window.close();
            }
        });
    </script>
</body>
</html>

