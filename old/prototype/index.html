<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ§åˆ¶å° - ä¸»ç•Œé¢</title>
    <link rel="stylesheet" href="assets/common.css">
    <style>
        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 200px;
            background: var(--bg-darker);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 12px 0;
        }

        .sidebar-item {
            width: 100%;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            white-space: nowrap;
        }

        .sidebar-item:hover {
            background: var(--bg-light);
            color: var(--text-primary);
        }

        .sidebar-item.active {
            background: var(--bg-light);
            color: var(--primary-color);
            border-left: 3px solid var(--primary-color);
        }

        .sidebar-icon {
            width: 24px;
            height: 24px;
            font-size: 20px;
            flex-shrink: 0;
        }

        .sidebar-text {
            font-size: 14px;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨æ  */
        .header {
            height: 60px;
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .provider-selector {
            padding: 6px 12px;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* å¯¹è¯åŒº */
        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }

        .welcome-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .welcome-title {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 32px;
            max-width: 800px;
        }

        .quick-action {
            padding: 16px;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .quick-action-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .quick-action-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* è¾“å…¥åŒº */
        .input-area {
            background: var(--bg-dark);
            border-top: 1px solid var(--border-color);
            padding: 16px 20px;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-box {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .input-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .input-tool-btn {
            padding: 4px 8px;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .input-tool-btn:hover {
            color: var(--text-primary);
            border-color: var(--primary-color);
        }

        #messageInput {
            min-height: 60px;
            max-height: 200px;
            resize: none;
            font-size: 14px;
            line-height: 1.5;
        }

        .send-btn {
            padding: 12px 24px;
            min-width: 80px;
        }

        /* å·¥å…·é¢æ¿ï¼ˆå³ä¾§ï¼‰ */
        .tools-panel {
            width: 0;
            background: var(--bg-dark);
            border-left: 1px solid var(--border-color);
            overflow: hidden;
            transition: width 0.3s;
        }

        .tools-panel.open {
            width: 320px;
        }

        /* å¿«æ·é”®æç¤º */
        .shortcut-hint {
            position: fixed;
            bottom: 100px;
            right: 20px;
            padding: 8px 12px;
            background: var(--bg-darker);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .shortcut-hint.show {
            opacity: 1;
        }

        /* æ‰“å­—æœºæ•ˆæœ */
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 8px 12px;
            background: var(--bg-light);
            border-radius: var(--radius);
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§å¯¼èˆªæ  -->
        <div class="sidebar">
            <a href="index.html" class="sidebar-item active">
                <span class="sidebar-icon">ğŸ’¬</span>
                <span class="sidebar-text">å¯¹è¯</span>
            </a>
            <a href="assistants.html" class="sidebar-item">
                <span class="sidebar-icon">ğŸ¤–</span>
                <span class="sidebar-text">åŠ©æ‰‹</span>
            </a>
            <a href="sessions.html" class="sidebar-item">
                <span class="sidebar-icon">ğŸ“š</span>
                <span class="sidebar-text">ä¼šè¯</span>
            </a>
            <a href="knowledge.html" class="sidebar-item">
                <span class="sidebar-icon">ğŸ“–</span>
                <span class="sidebar-text">çŸ¥è¯†åº“</span>
            </a>
            <a href="tools-sidebar.html" class="sidebar-item">
                <span class="sidebar-icon">ğŸ› ï¸</span>
                <span class="sidebar-text">å·¥å…·</span>
            </a>
            <a href="logs.html" class="sidebar-item">
                <span class="sidebar-icon">ğŸ“‹</span>
                <span class="sidebar-text">æ—¥å¿—</span>
            </a>
            <a href="settings.html" class="sidebar-item">
                <span class="sidebar-icon">âš™ï¸</span>
                <span class="sidebar-text">è®¾ç½®</span>
            </a>
            <div style="flex: 1;"></div>
            <div class="sidebar-item" onclick="showCommandPalette()">
                <span class="sidebar-icon">âŒ˜</span>
                <span class="sidebar-text">å‘½ä»¤é¢æ¿</span>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- é¡¶éƒ¨æ  -->
            <div class="header">
                <div class="header-left">
                    <div class="logo">AI æ§åˆ¶å°</div>
                    <div class="provider-selector" onclick="toggleProviderMenu()">
                        <span class="status-indicator status-success"></span>
                        <span id="currentProvider">ç™¾ç‚¼ Qwen-Plus</span>
                        <span>â–¼</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="status-bar">
                        <span>ä¼šè¯: 1</span>
                        <span>|</span>
                        <span>æ¶ˆæ¯: 0</span>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="newChat()">æ–°å»ºå¯¹è¯</button>
                    <button class="btn btn-secondary btn-small" onclick="toggleToolsPanel()">å·¥å…· â–¶</button>
                </div>
            </div>

            <!-- å¯¹è¯å®¹å™¨ -->
            <div class="chat-container">
                <div class="chat-main">
                    <!-- æ¶ˆæ¯åŒº -->
                    <div class="messages-area" id="messagesArea">
                        <div class="welcome-screen" id="welcomeScreen">
                            <div class="welcome-icon">ğŸ¤–</div>
                            <div class="welcome-title">æ¬¢è¿ä½¿ç”¨ AI æ§åˆ¶å°</div>
                            <div>ç»Ÿä¸€æ¥å…¥ç™¾ç‚¼ä¸ Ollamaï¼Œè°ƒç”¨ MCP å·¥å…·ï¼Œæ§åˆ¶æœ¬åœ°èƒ½åŠ›</div>
                            
                            <div class="quick-actions">
                                <div class="quick-action" onclick="window.location.href='assistants.html'">
                                    <div class="quick-action-title">ğŸ¤– AI åŠ©æ‰‹</div>
                                    <div class="quick-action-desc">åˆ›å»ºå’Œç®¡ç†ä¸“ä¸šåŠ©æ‰‹</div>
                                </div>
                                <div class="quick-action" onclick="window.location.href='knowledge.html'">
                                    <div class="quick-action-title">ğŸ“– çŸ¥è¯†åº“</div>
                                    <div class="quick-action-desc">RAG å¢å¼ºçŸ¥è¯†æ£€ç´¢</div>
                                </div>
                                <div class="quick-action" onclick="quickAction('file')">
                                    <div class="quick-action-title">ğŸ“ æ–‡ä»¶æ“ä½œ</div>
                                    <div class="quick-action-desc">è¯»å–ã€æœç´¢ã€ç®¡ç†æ–‡ä»¶</div>
                                </div>
                                <div class="quick-action" onclick="quickAction('script')">
                                    <div class="quick-action-title">âš¡ æ‰§è¡Œè„šæœ¬</div>
                                    <div class="quick-action-desc">è¿è¡Œ PowerShell/Python è„šæœ¬</div>
                                </div>
                                <div class="quick-action" onclick="quickAction('mcp')">
                                    <div class="quick-action-title">ğŸ”§ MCP å·¥å…·</div>
                                    <div class="quick-action-desc">è°ƒç”¨å¤–éƒ¨å·¥å…·å’ŒæœåŠ¡</div>
                                </div>
                                <div class="quick-action" onclick="window.location.href='sessions.html'">
                                    <div class="quick-action-title">ğŸ“š ä¼šè¯ç®¡ç†</div>
                                    <div class="quick-action-desc">æŸ¥çœ‹å†å²å¯¹è¯è®°å½•</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è¾“å…¥åŒº -->
                    <div class="input-area">
                        <div class="input-wrapper">
                            <div class="input-box">
                                <div class="input-tools">
                                    <button class="input-tool-btn" title="é™„åŠ æ–‡ä»¶">ğŸ“ æ–‡ä»¶</button>
                                    <button class="input-tool-btn" title="å¼•ç”¨ä¸Šä¸‹æ–‡">ğŸ”— å¼•ç”¨</button>
                                    <button class="input-tool-btn" title="ä½¿ç”¨æ¨¡æ¿">ğŸ“ æ¨¡æ¿</button>
                                    <button class="input-tool-btn" onclick="showCommandPalette()">âŒ˜ å‘½ä»¤ (Ctrl+K)</button>
                                </div>
                                <textarea 
                                    id="messageInput" 
                                    placeholder="è¾“å…¥æ¶ˆæ¯...æ”¯æŒè‡ªç„¶è¯­è¨€æˆ–å‘½ä»¤æ¨¡å¼ï¼ˆ/ps, /tool ç­‰ï¼‰"
                                    onkeydown="handleInputKeydown(event)"
                                ></textarea>
                            </div>
                            <button class="btn btn-primary send-btn" onclick="sendMessage()">
                                <span id="sendBtnText">å‘é€</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§å·¥å…·é¢æ¿ -->
                <div class="tools-panel" id="toolsPanel">
                    <iframe src="tools-sidebar.html" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«æ·é”®æç¤º -->
    <div class="shortcut-hint" id="shortcutHint">
        æŒ‰ Ctrl+K æ‰“å¼€å‘½ä»¤é¢æ¿
    </div>

    <script src="assets/common.js"></script>
    <script>
        let messages = [];
        let isProcessing = false;

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || isProcessing) return;
            
            // éšè—æ¬¢è¿å±å¹•
            document.getElementById('welcomeScreen').style.display = 'none';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', content);
            input.value = '';
            
            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
            showTypingIndicator();
            
            // æ¨¡æ‹ŸAIå“åº”
            setTimeout(() => {
                hideTypingIndicator();
                handleAIResponse(content);
            }, 1500);
        }

        // æ·»åŠ æ¶ˆæ¯
        function addMessage(role, content) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(contentDiv);
            messagesArea.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            messages.push({ role, content, timestamp: new Date() });
        }

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const messagesArea = document.getElementById('messagesArea');
            const indicator = document.createElement('div');
            indicator.id = 'typingIndicator';
            indicator.className = 'message message-assistant';
            indicator.innerHTML = `
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesArea.appendChild(indicator);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            isProcessing = true;
        }

        // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
            isProcessing = false;
        }

        // å¤„ç†AIå“åº”
        function handleAIResponse(userInput) {
            let response = '';
            
            // ç®€å•çš„æ¨¡æ‹Ÿå“åº”
            if (userInput.includes('æ–‡ä»¶') || userInput.includes('ç›®å½•')) {
                response = 'æˆ‘å¯ä»¥å¸®æ‚¨è¿›è¡Œæ–‡ä»¶æ“ä½œã€‚è¯·å‘Šè¯‰æˆ‘å…·ä½“éœ€è¦ï¼š\n\n1. è¯»å–æ–‡ä»¶å†…å®¹\n2. æœç´¢æ–‡ä»¶\n3. æ‰¹é‡å¤„ç†\n4. æ–‡ä»¶ç®¡ç†\n\néœ€è¦æˆ‘åšä»€ä¹ˆå‘¢ï¼Ÿ';
            } else if (userInput.startsWith('/ps')) {
                response = 'å‡†å¤‡æ‰§è¡Œ PowerShell å‘½ä»¤...\n\nâš ï¸ æ­¤æ“ä½œéœ€è¦æ‚¨çš„å®¡æ‰¹ç¡®è®¤ã€‚';
                setTimeout(() => window.open('approval-dialog.html', '_blank', 'width=600,height=400'), 1000);
            } else if (userInput.includes('å·¥å…·') || userInput.includes('MCP')) {
                response = 'å·²è¿æ¥çš„ MCP å·¥å…·ï¼š\n\nâœ… files - æ–‡ä»¶æ“ä½œ\nâœ… devops - DevOps å·¥å…·\nâš ï¸ database - æ•°æ®åº“ï¼ˆç¦»çº¿ï¼‰\n\næ‚¨æƒ³ä½¿ç”¨å“ªä¸ªå·¥å…·ï¼Ÿ';
            } else {
                response = `æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼š"${userInput}"\n\næˆ‘æ˜¯ AI æ§åˆ¶å°åŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨ï¼š\n- ç®¡ç†æ–‡ä»¶å’Œç›®å½•\n- æ‰§è¡Œè„šæœ¬å’Œå‘½ä»¤\n- è°ƒç”¨ MCP å·¥å…·\n- æ§åˆ¶æœ¬åœ°ç³»ç»Ÿèƒ½åŠ›\n\nè¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ã€‚`;
            }
            
            addMessage('assistant', response);
        }

        // å¿«æ·æ“ä½œ
        function quickAction(type) {
            const actions = {
                file: 'å¸®æˆ‘æœç´¢ D:\\WorkSpace ä¸‹çš„æ‰€æœ‰ .md æ–‡ä»¶',
                script: '/ps Get-Process | Sort-Object CPU -Descending | Select-Object -First 10',
                mcp: 'åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ MCP å·¥å…·',
                help: 'æ˜¾ç¤ºä½¿ç”¨å¸®åŠ©å’Œç¤ºä¾‹'
            };
            document.getElementById('messageInput').value = actions[type] || '';
            document.getElementById('messageInput').focus();
        }

        // è¾“å…¥æ¡†å¿«æ·é”®
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // æ–°å»ºå¯¹è¯
        function newChat() {
            if (messages.length > 0) {
                Utils.confirm('ç¡®å®šè¦å¼€å§‹æ–°å¯¹è¯å—ï¼Ÿå½“å‰å¯¹è¯å°†è¢«ä¿å­˜ã€‚', () => {
                    messages = [];
                    document.getElementById('messagesArea').innerHTML = '';
                    document.getElementById('welcomeScreen').style.display = 'flex';
                    Utils.showToast('å·²å¼€å§‹æ–°å¯¹è¯', 'success');
                });
            }
        }

        // åˆ‡æ¢å·¥å…·é¢æ¿
        function toggleToolsPanel() {
            const panel = document.getElementById('toolsPanel');
            panel.classList.toggle('open');
        }

        // æ˜¾ç¤ºå‘½ä»¤é¢æ¿
        function showCommandPalette() {
            window.open('command-palette.html', '_blank', 'width=800,height=600');
        }

        // åˆ‡æ¢ Provider èœå•
        function toggleProviderMenu() {
            Utils.showToast('æ¨¡å‹åˆ‡æ¢åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                showCommandPalette();
            }
        });

        // æ˜¾ç¤ºå¿«æ·é”®æç¤º
        setTimeout(() => {
            const hint = document.getElementById('shortcutHint');
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 3000);
        }, 2000);
    </script>
</body>
</html>

